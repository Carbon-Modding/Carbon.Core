###
### Copyright (c) 2023 Carbon Community 
### All rights reserved
###
name: Branch Merge
concurrency: merge-process-exec

on:
  workflow_dispatch:
    inputs:
      source:
        description: 'From branch'
        required: true
        default: 'develop'
        type: choice
        options:
          - develop
          - preview
          - preproduction
          - production
          - rust_beta/aux01
          - rust_beta/aux02
          - rust_beta/staging

      target:
        description: 'Target branch'
        required: true
        default: 'preview'
        type: choice
        options:
          - develop
          - preview
          - preproduction
          - production
          - rust_beta/aux01
          - rust_beta/aux02
          - rust_beta/staging

jobs:
  merge:
    name: üîÉ Merge branches
    runs-on: ubuntu-latest

    steps:
    - name: üîó Checkout source code from github
      uses: actions/checkout@v3

    - name: ‚§µÔ∏è Merge ${{ inputs.source }} into ${{ inputs.target }} - Primary repo
      uses: devmasx/merge-branch@master
      with:
        type: now
        from_branch: ${{ inputs.source }}
        target_branch: ${{ inputs.target }}
        github_token: ${{ secrets.PAT_PUBLIC_REPO }}
        message: |
          Merge ${{ inputs.source }} into ${{ inputs.target }}

    - name: ‚§µÔ∏è Merge ${{ inputs.source }} into ${{ inputs.target }} - Component repos
      run: |
        %GITHUB_WORKSPACE%\Tools\Build\branch_merge.bat ${{ inputs.source }} ${{ inputs.target }}
      env:
        GIT_AUTH_TOKEN: ${{ secrets.PAT_PUBLIC_REPO }}
